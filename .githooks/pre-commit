#!/bin/bash

# Pre-commit hook: ejecuta tests antes de cada commit
# Para instalar: cp .githooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

echo "ğŸ” Running pre-commit tests..."

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Flag para rastrear si algÃºn test fallÃ³
FAILED=0

# ===================================
# PHPUnit Tests
# ===================================
echo ""
echo "${YELLOW}ğŸ˜ Running PHPUnit tests...${NC}"
cd app
./vendor/bin/phpunit --testdox --colors=always

if [ $? -ne 0 ]; then
    echo "${RED}âŒ PHPUnit tests failed!${NC}"
    FAILED=1
else
    echo "${GREEN}âœ… PHPUnit tests passed!${NC}"
fi

# ===================================
# Vitest Tests
# ===================================
echo ""
echo "${YELLOW}âš¡ Running Vitest tests...${NC}"
npm test -- --run

if [ $? -ne 0 ]; then
    echo "${RED}âŒ Vitest tests failed!${NC}"
    FAILED=1
else
    echo "${GREEN}âœ… Vitest tests passed!${NC}"
fi

cd ..

# ===================================
# Resultado Final
# ===================================
echo ""
if [ $FAILED -eq 1 ]; then
    echo "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo "${RED}â•‘  âŒ COMMIT ABORTED - TESTS FAILED  âŒ â•‘${NC}"
    echo "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "Fix the failing tests before committing."
    echo "To skip this check (NOT RECOMMENDED), use: git commit --no-verify"
    exit 1
else
    echo "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo "${GREEN}â•‘  âœ… ALL TESTS PASSED - READY! âœ…   â•‘${NC}"
    echo "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    exit 0
fi
